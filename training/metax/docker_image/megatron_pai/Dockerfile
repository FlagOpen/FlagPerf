FROM flagperf_megatron:2.23.0.13
ENV PATH="/opt/conda/bin:${PATH}"
RUN /bin/bash -c "pip config set global.index-url https://mirror.baidu.com/pypi/simple"

ENV MACA_PATH="/opt/maca"
ENV MACA_CLANG_PATH="${MACA_PATH}/mxgpu_llvm/bin"
ENV MACA_CLANG="${MACA_PATH}/mxgpu_llvm"
ENV DEVINFO_ROOT="${MACA_PATH}"
ENV WCUDA_PATH="${MACA_PATH}/tools/wcuda"
ENV CUDA_PATH="${WCUDA_PATH}"
RUN unset CUDA_HOME
ENV PATH="${MACA_PATH}/bin:${MACA_CLANG}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${MACA_PATH}/lib:${MACA_PATH}/mxgpu_llvm/lib:${LD_LIBRARY_PATH}"

ENV MALLOC_THRESHOLD=99
ENV PYTORCH_CUDA_ALLOC_CONF="max_split_size_mb:64"

ENV MACA_SMALL_PAGESIZE_ENABLE=1
ENV MALLOC_THRESHOLD=95
ENV MCPYTORCH_DISABLE_PRINT=1

ENV MCCL_NET_GDR_LEVEL=7
#ENV MCCL_MIN_NCHANNELS=16
ENV MCCL_MAX_NCHANNELS=16
ENV MCCL_P2P_LEVEL=SYS
ENV MCCL_LIMIT_RING_LL_THREADTHRESHOLDS=1
ENV FORCE_ACTIVATE_WAIT=1

ENV MHA_USE_BLAS=ON
ENV LD_LIBRARY_PATH="/root/FWD_76_BWD_79:${LD_LIBRARY_PATH}"
ENV SET_DEVICE_NUMA_PREFERRED=1

ENV MAX_JOBS=20
ENV PYTORCH_ENABLE_SAME_RAND_A100=1

RUN /bin/bash -c "uname -a"
RUN /bin/bash -c alias python3=python
